apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: discord-bot-network-policy
spec:
  podSelector:
    matchLabels:
      app: discord-bot
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow inbound HTTPS traffic to container port 8080 (health checks)
  - ports:
    - port: 8080  # Container/pod port
      protocol: TCP
  egress:
  # Allow Discord WebSocket and HTTPS API connections
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
    ports:
    - port: 443
      protocol: TCP
  # Allow DNS resolution
  - to:
    ports:
    - port: 53
      protocol: UDP
    - port: 53
      protocol: TCP
  # Allow GKE metadata server access
  - to:
      - ipBlock:
          cidr: 169.254.169.254/32  # Google Cloud metadata server
    ports:
      - protocol: TCP
        port: 80
      - protocol: TCP
        port: 988
  - to:
      - ipBlock:
          cidr: 127.0.0.1/32  # For GKE versions prior to 1.21.0-gke.1000
    ports:
      - protocol: TCP
        port: 988
  # Allow Cloud SQL proxy to access Google APIs and Cloud SQL
  - to:
      - ipBlock:
          cidr: 199.36.153.8/30  # Restricted Google API access
      - ipBlock:
          cidr: 199.36.153.4/30  # Restricted Google API access
    ports:
      - protocol: TCP
        port: 443
  # Allow access to Google's DNS servers
  - to:
      - ipBlock:
          cidr: 8.8.8.8/32
      - ipBlock:
          cidr: 8.8.4.4/32
    ports:
      - protocol: UDP
        port: 53
      - protocol: TCP
        port: 53
